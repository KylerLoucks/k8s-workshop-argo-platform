name: GitOps Promote

# This workflow is used to promote the application's version.yaml file
on:
  # This workflow is triggered when the "Build changed apps and push to GHCR" workflow completes successfully.
  workflow_run:
    workflows: ["Build changed apps and push to GHCR"]
    types: [completed]
    branches: ["main"]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  resolve-tag:
    name: Resolve image tag from Build run
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    outputs:
      image_tag: ${{ steps.tag.outputs.image_tag }}
      head_sha: ${{ steps.tag.outputs.head_sha }}
      apps_json: ${{ steps.apps.outputs.apps_json }}
    steps:
      - id: tag
        shell: bash
        run: |
          set -euo pipefail

          head_sha="${{ github.event.workflow_run.head_sha || github.sha }}"
          image_tag="${head_sha:0:7}"

          echo "head_sha=$head_sha" >> "$GITHUB_OUTPUT"
          echo "image_tag=$image_tag" >> "$GITHUB_OUTPUT"
          echo "Using head_sha=$head_sha (image_tag=$image_tag)"

      # Download the changed apps artifact created by the Build run
      - name: Download changed apps artifact
        uses: actions/download-artifact@v4
        with:
          name: changed-apps-${{ github.event.workflow_run.id }}
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: artifacts

      # Read the changed apps list from the artifact created by the Build run
      - name: Read changed apps list
        id: apps
        shell: bash
        run: |
          set -euo pipefail
          file="artifacts/changed-apps.json"
          if [[ ! -f "$file" ]]; then
            echo "Changed apps artifact not found at $file" >&2
            exit 1
          fi

          apps_json="$(cat "$file")"
          echo "apps_json=$apps_json" >> "$GITHUB_OUTPUT"
          echo "Discovered changed apps: $apps_json"

  # Bump dev-us-version.yaml
  bump-dev-us:
    name: Bump dev-us version.yaml
    runs-on: ubuntu-latest
    needs: [resolve-tag]
    environment: development
    if: needs.resolve-tag.outputs.apps_json != '[]'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Bump dev-us version
        uses: ./.github/actions/gitops-bump-tags
        with:
          env_name: dev-us
          apps_json: ${{ needs.resolve-tag.outputs.apps_json }}
          image_tag: ${{ needs.resolve-tag.outputs.image_tag }}
          commit_message: "chore(deploy): bump dev-us-version.yaml to ${{ needs.resolve-tag.outputs.image_tag }}"

  # Gated promotion to prod-us (approval gate)
  bump-prod-us:
    name: Bump prod-us version.yaml
    runs-on: ubuntu-latest
    needs: [resolve-tag, bump-dev-us]
    environment: production
    if: needs.resolve-tag.outputs.apps_json != '[]'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Bump prod-us version
        uses: ./.github/actions/gitops-bump-tags
        with:
          env_name: prod-us
          apps_json: ${{ needs.resolve-tag.outputs.apps_json }}
          image_tag: ${{ needs.resolve-tag.outputs.image_tag }}
          commit_message: "chore(deploy): bump prod-us-version.yaml to ${{ needs.resolve-tag.outputs.image_tag }}"