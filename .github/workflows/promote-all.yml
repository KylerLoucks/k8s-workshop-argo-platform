name: Promote all applications in a single commit

on:
  workflow_dispatch:
    inputs:
      source_env:
        description: "Source environment"
        required: true
        default: "dev-us"
        type: choice
        options:
          - dev-us
          - prod-us

      target_env:
        description: "Target environment"
        required: true
        default: "prod-us"
        type: choice
        options:
          - dev-us
          - prod-us
          
      message:
        description: "Commit message"
        required: true
        type: string
        default: "Application promotion (all apps)"

concurrency:
  group: promote-all-${{ github.ref }}-${{ inputs.source_env }}-${{ inputs.target_env }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate inputs
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.validate.outputs.proceed }}
    steps:
      - id: validate
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ inputs.source_env }}" = "${{ inputs.target_env }}" ]; then
            echo "source_env and target_env are the same; nothing to promote." >&2
            exit 1
          fi

          echo "proceed=true" >> "$GITHUB_OUTPUT"

  discover-apps:
    name: Discover promotable Helm apps
    runs-on: ubuntu-latest
    needs: [validate]
    if: ${{ needs.validate.outputs.proceed == 'true' }}
    outputs:
      apps: ${{ steps.discover.outputs.apps }}
    steps:
      - uses: actions/checkout@v5
      - id: discover
        name: List Helm apps (JSON)
        shell: bash
        run: |
          set -euo pipefail

          # Discover charts by presence of helm/<app>/Chart.yaml
          apps_json=$(
            for chart in charts/*/Chart.yaml; do
              [ -f "$chart" ] || continue
              basename "$(dirname "$chart")"
            done | sort -u | jq -R . | jq -s -c .
          )

          if [ "$apps_json" = "[]" ]; then
            echo "No Helm apps discovered under ./charts/*/Chart.yaml" >&2
            exit 1
          fi

          echo "Discovered apps: $apps_json"
          echo "apps=$apps_json" >> "$GITHUB_OUTPUT"

  copy:
    name: Copy version file (per app)
    needs: [validate, discover-apps]
    runs-on: ubuntu-latest
    if: ${{ needs.validate.outputs.proceed == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.discover-apps.outputs.apps) }}
    steps:
      - uses: actions/checkout@v5

      - name: Copy image tag from ${{ inputs.source_env }} to ${{ inputs.target_env }}
        # If the source and target files already have identical contents, this ends up being a no-op:
        # there will be no git diff, so the final commit step will simply make no commit and still succeed.
        uses: canastro/copy-file-action@master
        with:
          source: values/${{ matrix.app }}/${{ inputs.source_env }}/version.yaml
          target: values/${{ matrix.app }}/${{ inputs.target_env }}/version.yaml

      - name: Upload promoted version file
        uses: actions/upload-artifact@v4
        with:
          name: promoted-${{ matrix.app }}
          path: values/${{ matrix.app }}/${{ inputs.target_env }}/version.yaml
          if-no-files-found: error

  commit:
    name: Commit promotion
    needs: [validate, copy]
    runs-on: ubuntu-latest
    if: ${{ needs.validate.outputs.proceed == 'true' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download promoted files
        uses: actions/download-artifact@v4
        with:
          pattern: promoted-*
          merge-multiple: true
          path: .

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: ${{ inputs.message }}

